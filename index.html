<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dutch Auction - Tender</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 4px;
      color: #38bdf8;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 20px;
    }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 16px;
      border: 1px solid #334155;
    }
    .card h2 {
      font-size: 1rem;
      color: #38bdf8;
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 4px;
      margin-top: 8px;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      background: #0f172a;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus { border-color: #38bdf8; }
    input::placeholder { color: #64748b; }
    .tender-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
      padding: 12px;
      background: #0f172a;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .tender-row .row-label {
      grid-column: 1 / -1;
      font-size: 0.75rem;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .tender-row label { margin-top: 0; }
    .tender-row input {
      background: #1e293b;
    }
    .info-bar {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.8rem;
      color: #94a3b8;
      border-bottom: 1px solid #334155;
      margin-bottom: 12px;
    }
    .info-bar span { color: #38bdf8; font-weight: 600; }
    button {
      width: 100%;
      padding: 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 12px;
    }
    button:hover { background: #1d4ed8; }
    button:disabled {
      background: #334155;
      color: #64748b;
      cursor: not-allowed;
    }
    .status {
      text-align: center;
      padding: 40px 20px;
      font-size: 1.1rem;
      color: #94a3b8;
    }
    .status .icon { font-size: 2.5rem; margin-bottom: 12px; }
    .success {
      background: #065f46;
      border-color: #10b981;
      text-align: center;
    }
    .success h2 { color: #34d399; }
    .error-msg {
      color: #f87171;
      font-size: 0.85rem;
      margin-top: 8px;
      text-align: center;
    }
    .results-card {
      border-color: #38bdf8;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #1e293b;
      font-size: 0.9rem;
    }
    .result-row:last-child { border-bottom: none; }
    .result-label { color: #94a3b8; }
    .result-value { color: #e2e8f0; font-weight: 600; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Dutch Auction</h1>
  <p class="subtitle">Share Repurchase Tender</p>

  <!-- Waiting Phase -->
  <div id="view-waiting" class="card">
    <div class="status">
      <div class="icon">&#9203;</div>
      <p>Waiting for the auction to open...</p>
      <p style="margin-top: 8px; font-size: 0.8rem;">The presenter will start the auction shortly</p>
    </div>
  </div>

  <!-- Name Entry (shown when auction opens) -->
  <div id="view-name" class="card hidden">
    <h2>Join the Auction</h2>
    <label for="name-input">Your Name</label>
    <input type="text" id="name-input" placeholder="Enter your name" maxlength="30" autocomplete="off">
    <button id="btn-name">Continue</button>
  </div>

  <!-- Tender Form -->
  <div id="view-tender" class="card hidden">
    <h2>Submit Your Tenders</h2>
    <div class="info-bar">
      <div>Your shares: <span id="info-shares">100</span></div>
      <div>Price range: <span id="info-range">$50 - $58</span></div>
    </div>
    <div id="remaining-display" style="text-align:center; margin-bottom:12px; font-size:0.85rem;">
      Shares remaining to allocate: <span id="shares-remaining" style="color:#38bdf8; font-weight:600;">100</span>
    </div>

    <div class="tender-row">
      <div class="row-label">Tender 1</div>
      <div>
        <label>Quantity</label>
        <input type="number" class="tender-qty" min="0" placeholder="0" data-row="0">
      </div>
      <div>
        <label>Price ($)</label>
        <input type="number" class="tender-price" min="50" max="58" step="0.5" placeholder="50-58" data-row="0">
      </div>
    </div>

    <div class="tender-row">
      <div class="row-label">Tender 2</div>
      <div>
        <label>Quantity</label>
        <input type="number" class="tender-qty" min="0" placeholder="0" data-row="1">
      </div>
      <div>
        <label>Price ($)</label>
        <input type="number" class="tender-price" min="50" max="58" step="0.5" placeholder="50-58" data-row="1">
      </div>
    </div>

    <div class="tender-row">
      <div class="row-label">Tender 3</div>
      <div>
        <label>Quantity</label>
        <input type="number" class="tender-qty" min="0" placeholder="0" data-row="2">
      </div>
      <div>
        <label>Price ($)</label>
        <input type="number" class="tender-price" min="50" max="58" step="0.5" placeholder="50-58" data-row="2">
      </div>
    </div>

    <div id="tender-error" class="error-msg hidden"></div>
    <button id="btn-submit">Submit Tenders</button>
  </div>

  <!-- Submitted Confirmation -->
  <div id="view-submitted" class="card success hidden">
    <h2>Tenders Submitted!</h2>
    <div id="submitted-summary" style="margin-top: 12px;"></div>
    <p style="margin-top: 16px; font-size: 0.85rem; color: #a7f3d0;">
      Waiting for the presenter to set the strike price...
    </p>
  </div>

  <!-- Results -->
  <div id="view-results" class="card results-card hidden">
    <h2>Your Results</h2>
    <div id="results-content"></div>
  </div>

  <script>
    const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProto}//${location.host}`);
    let myId = null;
    let myName = '';
    let config = {};

    // --- Views ---
    const views = {
      waiting: document.getElementById('view-waiting'),
      name: document.getElementById('view-name'),
      tender: document.getElementById('view-tender'),
      submitted: document.getElementById('view-submitted'),
      results: document.getElementById('view-results'),
    };

    function showView(name) {
      Object.values(views).forEach(v => v.classList.add('hidden'));
      views[name].classList.remove('hidden');
    }

    // --- WebSocket ---
    ws.onopen = () => {
      ws.send(JSON.stringify({ type: 'register-participant' }));
    };

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);

      switch (msg.type) {
        case 'registered':
          myId = msg.id;
          config = msg.config;
          if (msg.phase === 'open') {
            showView('name');
          } else {
            showView('waiting');
          }
          break;

        case 'phase':
          if (msg.phase === 'open') {
            if (msg.config) config = msg.config;
            showView('name');
          } else if (msg.phase === 'waiting') {
            showView('waiting');
          } else if (msg.phase === 'closed') {
            // If they haven't submitted, too late
          }
          break;

        case 'config-updated':
          config = msg.config;
          updateFormConfig();
          break;

        case 'submitted':
          showSubmitted(msg.tenders);
          break;

        case 'error':
          showError(msg.message);
          break;

        case 'results':
          showResults(msg);
          break;
      }
    };

    ws.onclose = () => {
      document.body.innerHTML = '<div class="card" style="margin-top: 40px;"><div class="status"><div class="icon">&#9888;</div><p>Connection lost. Please refresh the page.</p></div></div>';
    };

    // --- Form Logic ---
    function updateFormConfig() {
      document.getElementById('info-shares').textContent = config.sharesPerParticipant;
      document.getElementById('info-range').textContent = `$${config.priceMin} - $${config.priceMax}`;
      document.querySelectorAll('.tender-price').forEach(input => {
        input.min = config.priceMin;
        input.max = config.priceMax;
        input.placeholder = `${config.priceMin}-${config.priceMax}`;
      });
    }

    // Track remaining shares
    document.querySelectorAll('.tender-qty').forEach(input => {
      input.addEventListener('input', updateRemaining);
    });

    function updateRemaining() {
      const qtys = document.querySelectorAll('.tender-qty');
      let used = 0;
      qtys.forEach(q => { used += parseInt(q.value) || 0; });
      const remaining = (config.sharesPerParticipant || 100) - used;
      const el = document.getElementById('shares-remaining');
      el.textContent = remaining;
      el.style.color = remaining < 0 ? '#f87171' : '#38bdf8';
    }

    // Name button
    document.getElementById('btn-name').addEventListener('click', () => {
      const name = document.getElementById('name-input').value.trim();
      if (!name) return;
      myName = name;
      updateFormConfig();
      showView('tender');
    });

    // Allow Enter key on name input
    document.getElementById('name-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btn-name').click();
    });

    // Submit button
    document.getElementById('btn-submit').addEventListener('click', () => {
      const tenders = [];
      const qtyInputs = document.querySelectorAll('.tender-qty');
      const priceInputs = document.querySelectorAll('.tender-price');

      for (let i = 0; i < 3; i++) {
        const qty = parseInt(qtyInputs[i].value) || 0;
        const price = parseFloat(priceInputs[i].value) || 0;
        if (qty > 0 && price > 0) {
          tenders.push({ qty, price });
        }
      }

      if (tenders.length === 0) {
        showError('Please enter at least one tender');
        return;
      }

      const totalQty = tenders.reduce((s, t) => s + t.qty, 0);
      if (totalQty > config.sharesPerParticipant) {
        showError(`Total quantity (${totalQty}) exceeds your shares (${config.sharesPerParticipant})`);
        return;
      }

      for (const t of tenders) {
        if (t.price < config.priceMin || t.price > config.priceMax) {
          showError(`Price must be between $${config.priceMin} and $${config.priceMax}`);
          return;
        }
      }

      hideError();
      ws.send(JSON.stringify({ type: 'submit-tender', name: myName, tenders }));
    });

    function showError(msg) {
      const el = document.getElementById('tender-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('tender-error').classList.add('hidden');
    }

    function showSubmitted(tenders) {
      let html = '<div style="text-align:left;">';
      tenders.forEach((t, i) => {
        html += `<div class="result-row">
          <span class="result-label">Tender ${i + 1}</span>
          <span class="result-value">${t.qty} shares @ $${t.price.toFixed(2)}</span>
        </div>`;
      });
      html += '</div>';
      document.getElementById('submitted-summary').innerHTML = html;
      showView('submitted');
    }

    function showResults(msg) {
      const r = msg.results;
      const me = r.participants[myId];
      if (!me) {
        showView('results');
        document.getElementById('results-content').innerHTML = '<p>No results found for you.</p>';
        return;
      }

      // Determine rank
      const sorted = Object.entries(r.participants)
        .sort((a, b) => b[1].totalValue - a[1].totalValue);
      const rank = sorted.findIndex(([pid]) => pid === String(myId)) + 1;
      const total = sorted.length;
      const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : '';

      let html = `
        <div style="text-align:center; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #334155;">
          <div style="font-size:0.8rem; color:#94a3b8;">Your Rank</div>
          <div style="font-size:2rem; font-weight:700; color:#38bdf8;">${medal} #${rank} <span style="font-size:1rem; color:#64748b;">of ${total}</span></div>
        </div>
        <div class="result-row">
          <span class="result-label">Strike Price</span>
          <span class="result-value">$${r.strikePrice.toFixed(2)}</span>
        </div>
        <div class="result-row">
          <span class="result-label">Pro-rata Factor</span>
          <span class="result-value">${(me.proRataFactor * 100).toFixed(1)}%</span>
        </div>
        <div class="result-row">
          <span class="result-label">Shares Sold</span>
          <span class="result-value">${me.sharesActuallyTendered}</span>
        </div>
        <div class="result-row">
          <span class="result-label">Shares Remaining</span>
          <span class="result-value">${me.sharesRemaining}</span>
        </div>
        <div class="result-row">
          <span class="result-label">Cash</span>
          <span class="result-value">$${me.cashReceived.toFixed(2)}</span>
        </div>
        <div class="result-row">
          <span class="result-label">Shares Value</span>
          <span class="result-value">$${me.remainingValue.toFixed(2)}</span>
        </div>
        <div style="text-align:center; margin-top:16px; padding-top:16px; border-top:1px solid #334155;">
          <div style="font-size:0.8rem; color:#94a3b8;">Total Portfolio Value</div>
          <div style="font-size:1.4rem; font-weight:700; color:#38bdf8;">$${me.totalValue.toFixed(2)}</div>
        </div>
      `;

      document.getElementById('results-content').innerHTML = html;
      showView('results');
    }
  </script>
</body>
</html>
